<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChargeX Blockchain Integration Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #343a40;
            color: white;
            font-weight: bold;
        }
        .form-label {
            font-weight: bold;
        }
        #results {
            max-height: 400px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">ChargeX Blockchain Integration Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Register Device on Blockchain</div>
                    <div class="card-body">
                        <form id="registerDeviceForm">
                            <div class="mb-3">
                                <label for="deviceId" class="form-label">Device ID</label>
                                <input type="text" class="form-control" id="deviceId" value="test-device-003" required>
                            </div>
                            <div class="mb-3">
                                <label for="deviceType" class="form-label">Device Type</label>
                                <input type="text" class="form-control" id="deviceType" value="battery-monitor" required>
                            </div>
                            <div class="mb-3">
                                <label for="batteryId" class="form-label">Battery ID</label>
                                <input type="text" class="form-control" id="batteryId" value="test-battery-003" required>
                            </div>
                            <div class="mb-3">
                                <label for="serialNumber" class="form-label">Serial Number</label>
                                <input type="text" class="form-control" id="serialNumber" value="SN87654321">
                            </div>
                            <div class="mb-3">
                                <label for="firmwareVersion" class="form-label">Firmware Version</label>
                                <input type="text" class="form-control" id="firmwareVersion" value="1.0.0">
                            </div>
                            <button type="submit" class="btn btn-primary">Register Device</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Get Device Information</div>
                    <div class="card-body">
                        <form id="getDeviceInfoForm">
                            <div class="mb-3">
                                <label for="deviceIdInfo" class="form-label">Device ID</label>
                                <input type="text" class="form-control" id="deviceIdInfo" value="test-device-003" required>
                            </div>
                            <button type="submit" class="btn btn-info">Get Device Info</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Log Telemetry Data on Blockchain</div>
                    <div class="card-body">
                        <form id="logTelemetryForm">
                            <div class="mb-3">
                                <label for="telemetryDeviceId" class="form-label">Device ID</label>
                                <input type="text" class="form-control" id="telemetryDeviceId" value="test-device-003" required>
                            </div>
                            <div class="mb-3">
                                <label for="telemetryBatteryId" class="form-label">Battery ID</label>
                                <input type="text" class="form-control" id="telemetryBatteryId" value="test-battery-003" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="voltage" class="form-label">Voltage (V)</label>
                                    <input type="number" step="0.1" class="form-control" id="voltage" value="48.7" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="current" class="form-label">Current (A)</label>
                                    <input type="number" step="0.1" class="form-control" id="current" value="2.8" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="temperature" class="form-label">Temperature (°C)</label>
                                    <input type="number" step="0.1" class="form-control" id="temperature" value="24.5" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="stateOfCharge" class="form-label">State of Charge (%)</label>
                                    <input type="number" step="0.1" class="form-control" id="stateOfCharge" value="85.3" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="stateOfHealth" class="form-label">State of Health (%)</label>
                                    <input type="number" step="0.1" class="form-control" id="stateOfHealth" value="94.7" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="timestamp" class="form-label">Timestamp</label>
                                    <input type="text" class="form-control" id="timestamp" value="auto" disabled>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="latitude" class="form-label">Latitude</label>
                                    <input type="number" step="0.0001" class="form-control" id="latitude" value="37.7749" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="longitude" class="form-label">Longitude</label>
                                    <input type="number" step="0.0001" class="form-control" id="longitude" value="-122.4194" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Log Telemetry Data</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Get Telemetry Log</div>
                    <div class="card-body">
                        <form id="getTelemetryLogForm">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="telemetryLogDeviceId" class="form-label">Device ID</label>
                                    <input type="text" class="form-control" id="telemetryLogDeviceId" value="test-device-003" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="telemetryLogIndex" class="form-label">Log Index</label>
                                    <input type="number" class="form-control" id="telemetryLogIndex" value="0" min="0" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-info">Get Telemetry Log</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">Results</div>
            <div class="card-body">
                <div id="results">
                    <p>API responses will appear here...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resultsDiv = document.getElementById('results');
            
            // Register Device Form
            document.getElementById('registerDeviceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const deviceData = {
                    _id: document.getElementById('deviceId').value,
                    deviceType: document.getElementById('deviceType').value,
                    batteryId: document.getElementById('batteryId').value,
                    serialNumber: document.getElementById('serialNumber').value,
                    firmwareVersion: document.getElementById('firmwareVersion').value
                };
                
                try {
                    appendToResults('Registering device on blockchain...');
                    
                    const response = await fetch('/api/v1/blockchain/register-device', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock-token'
                        },
                        body: JSON.stringify(deviceData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        appendToResults(`✅ Device registration successful!`, 'success');
                        appendToResults(`Transaction Hash: ${result.transactionHash}`, 'success');
                    } else {
                        appendToResults(`❌ Device registration failed: ${result.message}`, 'error');
                    }
                    
                    appendToResults(`Response: ${JSON.stringify(result, null, 2)}`);
                } catch (error) {
                    appendToResults(`❌ Error: ${error.message}`, 'error');
                }
            });
            
            // Log Telemetry Form
            document.getElementById('logTelemetryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const telemetryData = {
                    deviceId: document.getElementById('telemetryDeviceId').value,
                    batteryId: document.getElementById('telemetryBatteryId').value,
                    timestamp: Date.now(),
                    voltage: parseFloat(document.getElementById('voltage').value),
                    current: parseFloat(document.getElementById('current').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    stateOfCharge: parseFloat(document.getElementById('stateOfCharge').value),
                    stateOfHealth: parseFloat(document.getElementById('stateOfHealth').value),
                    latitude: parseFloat(document.getElementById('latitude').value),
                    longitude: parseFloat(document.getElementById('longitude').value)
                };
                
                try {
                    appendToResults('Logging telemetry data on blockchain...');
                    
                    const response = await fetch('/api/v1/blockchain/log-telemetry', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock-token'
                        },
                        body: JSON.stringify(telemetryData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        appendToResults(`✅ Telemetry logging successful!`, 'success');
                        appendToResults(`Transaction Hash: ${result.transactionHash}`, 'success');
                    } else {
                        appendToResults(`❌ Telemetry logging failed: ${result.message}`, 'error');
                    }
                    
                    appendToResults(`Response: ${JSON.stringify(result, null, 2)}`);
                } catch (error) {
                    appendToResults(`❌ Error: ${error.message}`, 'error');
                }
            });
            
            // Get Device Info Form
            document.getElementById('getDeviceInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const deviceId = document.getElementById('deviceIdInfo').value;
                
                try {
                    appendToResults(`Retrieving device information for ${deviceId}...`);
                    
                    const response = await fetch(`/api/v1/blockchain/device-info/${deviceId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer mock-token'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        appendToResults(`✅ Device information retrieval successful!`, 'success');
                    } else {
                        appendToResults(`❌ Device information retrieval failed: ${result.message}`, 'error');
                    }
                    
                    appendToResults(`Response: ${JSON.stringify(result, null, 2)}`);
                } catch (error) {
                    appendToResults(`❌ Error: ${error.message}`, 'error');
                }
            });
            
            // Get Telemetry Log Form
            document.getElementById('getTelemetryLogForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const deviceId = document.getElementById('telemetryLogDeviceId').value;
                const index = document.getElementById('telemetryLogIndex').value;
                
                try {
                    appendToResults(`Retrieving telemetry log at index ${index} for device ${deviceId}...`);
                    
                    const response = await fetch(`/api/v1/blockchain/telemetry-log/${deviceId}/${index}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer mock-token'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        appendToResults(`✅ Telemetry log retrieval successful!`, 'success');
                    } else {
                        appendToResults(`❌ Telemetry log retrieval failed: ${result.message}`, 'error');
                    }
                    
                    appendToResults(`Response: ${JSON.stringify(result, null, 2)}`);
                } catch (error) {
                    appendToResults(`❌ Error: ${error.message}`, 'error');
                }
            });
            
            // Helper function to append results
            function appendToResults(message, className = '') {
                const timestamp = new Date().toLocaleTimeString();
                const p = document.createElement('p');
                p.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                
                if (className) {
                    p.classList.add(className);
                }
                
                resultsDiv.appendChild(p);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }
        });
    </script>
</body>
</html>
